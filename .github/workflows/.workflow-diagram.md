# Workflow Diagram

## Como Funciona o Deploy AutomÃ¡tico

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. VocÃª faz um release do equidade-data-package            â”‚
â”‚     $ ./scripts/release.sh                                  â”‚
â”‚     ou                                                       â”‚
â”‚     $ gh release create v0.2.3                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. GitHub Action "Trigger Deploys" Ã© disparado             â”‚
â”‚     ğŸ“ .github/workflows/trigger-deploys.yml                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Action lÃª lista de repositÃ³rios da matrix               â”‚
â”‚     env:                                                     â”‚
â”‚       GITHUB_ORG: 'sua-org'                                 â”‚
â”‚     strategy:                                                â”‚
â”‚       matrix:                                                â”‚
â”‚         repo:                                                â”‚
â”‚           - cloud-function-1                                â”‚
â”‚           - cloud-function-2                                â”‚
â”‚           - cloud-function-3                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚              â”‚              â”‚
          â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Dispara em  â”‚ â”‚ Dispara em  â”‚ â”‚ Dispara em  â”‚
â”‚ cloud-      â”‚ â”‚ cloud-      â”‚ â”‚ cloud-      â”‚
â”‚ function-1  â”‚ â”‚ function-2  â”‚ â”‚ function-3  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚               â”‚
       â”‚               â”‚               â”‚
(repository_dispatch event com payload)
       â”‚               â”‚               â”‚
       â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Cada repositÃ³rio executa seu workflow    â”‚
â”‚     ğŸ“ .github/workflows/deploy.yml          â”‚
â”‚                                               â”‚
â”‚     on:                                       â”‚
â”‚       repository_dispatch:                   â”‚
â”‚         types: [package-updated]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. Workflow atualiza requirements.txt       â”‚
â”‚     equidade-data-package==0.2.3             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Deploy da Cloud Function com novo pacote â”‚
â”‚     $ gcloud functions deploy ...            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. âœ… Cloud Function atualizada e rodando!  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Payload do repository_dispatch

Quando o trigger-deploys.yml dispara um evento em cada repositÃ³rio, ele envia:

```json
{
  "package": "equidade-data-package",
  "version": "v0.2.3",
  "triggered_by": "spacejao",
  "source_repo": "org/equidade-data-package",
  "repo_name": "cloud-function-1"
}
```

Cada repositÃ³rio pode acessar esses dados via:
- `${{ github.event.client_payload.version }}`
- `${{ github.event.client_payload.triggered_by }}`
- etc.

## Fluxo de Tempo

```
T+0s   : VocÃª cria release v0.2.3
T+5s   : GitHub Action trigger-deploys inicia
T+10s  : Eventos repository_dispatch enviados
T+15s  : Workflows nos repos comeÃ§am (em paralelo)
T+30s  : requirements.txt atualizados
T+1m   : InÃ­cio dos deploys no GCP
T+3-5m : âœ… Todos os deploys completos
```

## SeguranÃ§a

1. **Personal Access Token (PAT)** com scopes:
   - `repo` - Acesso aos repositÃ³rios
   - `workflow` - Disparar workflows

2. **Secrets necessÃ¡rios**:
   - No equidade-data-package:
     - `DEPLOY_TRIGGER_TOKEN` - PAT para disparar workflows

   - Em cada Cloud Function:
     - `GCP_SA_KEY` - Service account para deploy

3. **PermissÃµes do Service Account** (GCP):
   - Cloud Functions Developer
   - Service Account User
   - (outras permissÃµes necessÃ¡rias pela funÃ§Ã£o)

## Vantagens

âœ… **Zero trabalho manual**: Um release atualiza tudo
âœ… **Deploys em paralelo**: Todas as funÃ§Ãµes atualizam ao mesmo tempo
âœ… **RastreÃ¡vel**: Logs completos no GitHub Actions
âœ… **ReversÃ­vel**: FÃ¡cil fazer rollback se necessÃ¡rio
âœ… **EscalÃ¡vel**: Adicionar nova funÃ§Ã£o = adicionar uma linha
âœ… **Seguro**: Usa tokens e secrets do GitHub

## Troubleshooting Visual

```
âŒ Trigger falhou
â”‚
â”œâ”€ Secret DEPLOY_TRIGGER_TOKEN nÃ£o configurado?
â”‚  â†’ Settings â†’ Secrets â†’ Actions
â”‚
â”œâ”€ OrganizaÃ§Ã£o errada no workflow?
â”‚  â†’ Editar GITHUB_ORG em trigger-deploys.yml
â”‚
â””â”€ PAT sem permissÃµes?
   â†’ Regenerar com scopes: repo, workflow

âŒ Deploy da Cloud Function falhou
â”‚
â”œâ”€ Secret GCP_SA_KEY nÃ£o configurado?
â”‚  â†’ Settings â†’ Secrets â†’ Actions (no repo da funÃ§Ã£o)
â”‚
â”œâ”€ Service account sem permissÃµes?
â”‚  â†’ IAM no GCP, adicionar roles necessÃ¡rios
â”‚
â””â”€ Nome da funÃ§Ã£o errado?
   â†’ Verificar FUNCTION_NAME em deploy.yml
```

## Exemplo Completo Real

```bash
# 1. Fazer mudanÃ§a no pacote
$ cd equidade-data-package
$ vim equidade_data_package/gcp/bigquery.py
$ pytest tests/

# 2. Fazer release (interativo)
$ ./scripts/release.sh

â„¹ Current version: 0.2.2
Enter new version: 0.2.3
Select release type: 2 (minor)
Continue? y

âœ“ Tests passed
âœ“ Package built
âœ“ Changes committed
âœ“ Tag created
âœ“ Pushed to remote
âœ“ GitHub release created

# 3. GitHub automaticamente:
# - Dispara trigger-deploys.yml
# - Envia evento para cloud-function-1 âœ…
# - Envia evento para cloud-function-2 âœ…
# - Envia evento para cloud-function-3 âœ…

# 4. Cada Cloud Function automaticamente:
# - Atualiza requirements.txt
# - Faz deploy no GCP
# - Verifica status

# 5. Monitorar
$ gh run list
# Mostra todos os workflows rodando

$ gh run view 12345 --log
# Ver logs de um workflow especÃ­fico

# 6. Verificar no GCP
$ gcloud functions list
# Todas as funÃ§Ãµes atualizadas com v0.2.3

# 7. âœ… DONE! CafÃ©? â˜•
```
